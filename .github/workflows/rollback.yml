# Deprecated rollback workflow (disabled)
name: Deprecated Rollback (Disabled)

on:
  workflow_dispatch:
    inputs:
      note:
        description: "Legacy rollback retained for reference"
        required: false

env:
  AZURE_LOCATION: "East US"
  ENVIRONMENT: "prod"
  RESOURCE_GROUP: "vcarpool-rg"

jobs:
  validate-rollback:
    name: Validate Rollback Request
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.validate.outputs.proceed }}
    steps:
      - name: Validate rollback confirmation
        id: validate
        run: |
          if [ "${{ github.event.inputs.confirm_rollback }}" != "CONFIRM" ]; then
            echo "❌ Rollback not confirmed. Please type 'CONFIRM' to proceed."
            exit 1
          fi

          echo "proceed=true" >> $GITHUB_OUTPUT

          echo "✅ Rollback confirmed for production environment"
          echo "Component: ${{ github.event.inputs.component }}"
          echo "Target: ${{ github.event.inputs.rollback_tag }}"

  rollback-infrastructure:
    name: Rollback Infrastructure
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: needs.validate-rollback.outputs.proceed == 'true' && (github.event.inputs.component == 'all' || github.event.inputs.component == 'infrastructure')
    environment: prod
    steps:
      - name: Checkout rollback target
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.rollback_tag }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Rollback infrastructure
        run: |
          echo "Rolling back infrastructure to ${{ github.event.inputs.rollback_tag }}"
          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters appName=vcarpool \
            --parameters environmentName=${{ env.ENVIRONMENT }} \
            --parameters location="${{ env.AZURE_LOCATION }}"

  rollback-backend:
    name: Rollback Backend
    runs-on: ubuntu-latest
    needs: [validate-rollback, rollback-infrastructure]
    if: always() && needs.validate-rollback.outputs.proceed == 'true' && (github.event.inputs.component == 'all' || github.event.inputs.component == 'backend')
    environment: prod
    steps:
      - name: Checkout rollback target
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.rollback_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install and build
        run: |
          npm ci
          npm run build:shared
          npm run build:backend

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy backend rollback
        uses: Azure/functions-action@v1
        with:
          app-name: vcarpool-api-prod
          package: backend/

  rollback-frontend:
    name: Rollback Frontend
    runs-on: ubuntu-latest
    needs: [validate-rollback, rollback-infrastructure]
    if: always() && needs.validate-rollback.outputs.proceed == 'true' && (github.event.inputs.component == 'all' || github.event.inputs.component == 'frontend')
    environment: prod
    steps:
      - name: Checkout rollback target
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.rollback_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install and build
        run: |
          npm ci
          npm run build:shared
          npm run build:frontend

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get Static Web App deployment token
        id: swa-token
        run: |
          TOKEN=$(az staticwebapp secrets list \
            --name vcarpool-web-prod \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query 'properties.apiKey' \
            --output tsv)
          echo "swa-token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Deploy frontend rollback
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.swa-token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "frontend"
          output_location: "frontend/.next"
          skip_app_build: true

  verify-rollback:
    name: Verify Rollback
    runs-on: ubuntu-latest
    needs: [validate-rollback, rollback-backend, rollback-frontend]
    if: always() && needs.validate-rollback.outputs.proceed == 'true'
    steps:
      - name: Test endpoints
        run: |
          FUNCTION_ENDPOINT="https://vcarpool-api-prod.azurewebsites.net/api"
          STATIC_ENDPOINT="https://vcarpool-web-prod.azurestaticapps.net"

          echo "Testing rollback..."
          sleep 60  # Wait for deployments to stabilize

          if curl -f "$FUNCTION_ENDPOINT/health"; then
            echo "✅ Backend rollback successful"
          else
            echo "❌ Backend rollback may have failed"
          fi

          if curl -f "$STATIC_ENDPOINT"; then
            echo "✅ Frontend rollback successful"
          else
            echo "❌ Frontend rollback may have failed"
          fi

      - name: Rollback summary
        run: |
          echo "## 🔄 Rollback Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Component**: ${{ github.event.inputs.component }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ github.event.inputs.rollback_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Completed" >> $GITHUB_STEP_SUMMARY
