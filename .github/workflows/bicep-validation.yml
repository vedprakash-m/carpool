name: ğŸ” Bicep Template Validation

on:
  pull_request:
    branches: [main]
    paths:
      - 'infra/**/*.bicep'
      - 'infra/**/*.json'
  push:
    branches: [main]
    paths:
      - 'infra/**/*.bicep'
      - 'infra/**/*.json'
  workflow_dispatch:

env:
  AZURE_LOCATION: 'eastus'

permissions:
  contents: read
  id-token: write

jobs:
  validate-bicep:
    name: ğŸ—ï¸ Validate Bicep Templates
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, prod]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Validate database template
        run: |
          echo "ğŸ” Validating database.bicep for ${{ matrix.environment }}..."

          az deployment group validate \
            --resource-group "temp-validation-rg" \
            --template-file "infra/database.bicep" \
            --parameters "infra/parameters.${{ matrix.environment }}.json" \
            --mode Complete \
            --verbose || {
              echo "âŒ Database template validation failed for ${{ matrix.environment }}"
              exit 1
            }

          echo "âœ… Database template validation passed for ${{ matrix.environment }}"

      - name: Validate compute template
        run: |
          echo "ğŸ” Validating main-compute.bicep for ${{ matrix.environment }}..."

          az deployment group validate \
            --resource-group "temp-validation-rg" \
            --template-file "infra/main-compute.bicep" \
            --parameters "infra/parameters.${{ matrix.environment }}.json" \
            --parameters databaseResourceGroup="temp-db-validation-rg" \
            --mode Complete \
            --verbose || {
              echo "âŒ Compute template validation failed for ${{ matrix.environment }}"
              exit 1
            }

          echo "âœ… Compute template validation passed for ${{ matrix.environment }}"

      - name: Test template what-if analysis
        run: |
          echo "ğŸ” Running what-if analysis for ${{ matrix.environment }}..."

          # Database what-if
          az deployment group what-if \
            --resource-group "temp-validation-rg" \
            --template-file "infra/database.bicep" \
            --parameters "infra/parameters.${{ matrix.environment }}.json" \
            --verbose

          echo "âœ… What-if analysis completed for ${{ matrix.environment }}"

  lint-bicep:
    name: ğŸ§¹ Lint Bicep Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bicep CLI
        run: |
          curl -Lo bicep https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64
          chmod +x ./bicep
          sudo mv ./bicep /usr/local/bin/bicep

      - name: Lint Bicep templates
        run: |
          echo "ğŸ§¹ Linting Bicep templates..."

          # Lint all Bicep files
          for bicep_file in infra/*.bicep; do
            echo "Linting $bicep_file..."
            bicep build "$bicep_file" --stdout > /dev/null
            echo "âœ… $bicep_file passed linting"
          done

          echo "âœ… All Bicep templates passed linting"

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Bicep security scan
        run: |
          echo "ğŸ”’ Running security scan on Bicep templates..."

          # This would normally use tools like Checkov or custom security rules
          # For now, we'll check for basic security patterns

          echo "ğŸ” Checking for security best practices..."

          # Check for HTTPS enforcement
          if grep -r "httpsOnly.*true" infra/*.bicep; then
            echo "âœ… HTTPS enforcement found"
          else
            echo "âš ï¸ Consider enforcing HTTPS for web resources"
          fi

          # Check for minimum TLS version
          if grep -r "minTlsVersion.*1.2" infra/*.bicep; then
            echo "âœ… Minimum TLS version configured"
          else
            echo "âš ï¸ Consider setting minimum TLS version to 1.2"
          fi

          # Check for storage encryption
          if grep -r "supportsHttpsTrafficOnly.*true" infra/*.bicep; then
            echo "âœ… Storage HTTPS enforcement found"
          else
            echo "âš ï¸ Consider enforcing HTTPS for storage accounts"
          fi

          echo "âœ… Security scan completed"

  resource-costs:
    name: ğŸ’° Estimate Costs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Estimate deployment costs
        run: |
          echo "ğŸ’° Estimating deployment costs..."

          echo "ğŸ“Š Estimated monthly costs by environment:"
          echo ""
          echo "ğŸ§ª Development Environment:"
          echo "  - Cosmos DB (400 RU/s): ~$24/month"
          echo "  - Function App (Consumption): ~$0-5/month"
          echo "  - Static Web App (Free): $0/month"
          echo "  - Storage Account: ~$1-2/month"
          echo "  - Application Insights: ~$0-2/month"
          echo "  Total: ~$25-35/month"
          echo ""
          echo "ğŸš€ Production Environment:"
          echo "  - Cosmos DB (400 RU/s): ~$24/month"
          echo "  - Function App (Basic): ~$50-100/month"
          echo "  - Static Web App (Standard): ~$9/month"
          echo "  - Storage Account: ~$2-5/month"
          echo "  - Application Insights: ~$0-5/month"
          echo "  Total: ~$85-145/month"
          echo ""
          echo "ğŸ’¡ Cost optimization tip: Delete compute resource group when not needed"
          echo "   Database RG (persistent): ~$24/month"
          echo "   Compute RG (can delete): ~$60-120/month"

  validation-summary:
    name: ğŸ“‹ Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-bicep, lint-bicep, security-scan, resource-costs]
    if: always()
    steps:
      - name: Display validation results
        run: |
          echo "ğŸ“‹ Bicep Template Validation Summary:"
          echo ""
          echo "ğŸ” Template Validation: ${{ needs.validate-bicep.result }}"
          echo "ğŸ§¹ Linting: ${{ needs.lint-bicep.result }}"
          echo "ğŸ”’ Security Scan: ${{ needs.security-scan.result }}"
          echo "ğŸ’° Cost Estimation: ${{ needs.resource-costs.result }}"
          echo ""

          if [[ "${{ needs.validate-bicep.result }}" == "success" && 
                "${{ needs.lint-bicep.result }}" == "success" && 
                "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "âœ… All Bicep validation checks passed!"
            echo "ğŸš€ Templates are ready for deployment"
          else
            echo "âŒ Some validation checks failed"
            echo "ğŸ”§ Please review and fix the issues before deployment"
            exit 1
          fi
